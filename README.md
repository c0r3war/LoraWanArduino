# LoraWan Arduino tests on Heltec LORA 32

## Setup of VSCode

1) Install Arduino IDE
2) Install VSCode
3) Install Arduino extension from Microsoft
4) In Arduino IDE, install Heltec Lora 32 extension: https://heltec-automation-docs.readthedocs.io/en/latest/esp32/quick_start.html

## Setup project

1) Create a new workspace.
2) Create a folder for the project. Folder must contain subb directory named 'build' (this one will be used for Arduino build, it will speed up subsequent compilations). Add the project folder to workspace. 
3) Setup Git repo (don't forget to create a .gitignore to exclude the build folder, .vscode folder, etc).
4) Setup the Heltec Lora 32 board (shift+cmd+P, Arduino:Board Config), and the serial port to use (shif+cmd+P, Arduino:Select Serial Port).
5) Setup libraries (shift+cmd+P, Arduino: Library Manager): you will need MCCI LoraWan LMIC Libray (https://github.com/mcci-catena/arduino-lmic) and U8g2 for screen (https://github.com/olikraus/u8g2).
6) Configure project settings in arduino.json:
    * "output": "build" (will save you time during build)
7) Don't forget to setup LMIC library. You have to tell the library the radio region AND the Lora chip of your board (Semtech sx1276 for the Heltec board). This can be done either through compiler options (but looks like it's pretty complicated/not recommended with Arduino IDE), or by editing *project_config/lmic_project_config.h* file, more informations in the [README.MD](https://github.com/mcci-catena/arduino-lmic#adding-regions) of the MCCI LMIC lib.  
Unfortunatelly, in Arduino environment, the lmic_project_config.h is shared among all projetcts (so your settings will have to be the same, this should not be an issue for simple projects). You will find the file in the Arduino libraries folder, in *MCCI_LoRaWAN_LMIC_library/project_config/*.

## References/articles
### Articles used to develop this test
TTN Howto with Heltec Lora 32 and the LMIC library: https://nathanmcminn.com/2018/09/12/tutorial-heltec-esp32-board-the-things-network/

ESP32 internal temperature sensor example: https://circuits4you.com/2019/01/01/esp32-internal-temperature-sensor-example/

Arduino libraries folder location: https://forum.arduino.cc/index.php?topic=88380.0

### Misc other articles
https://robotzero.one/heltec-lora32-lorawan-node/
Heltec library reference: https://github.com/HelTecAutomation/Heltec_ESP32#api-reference
ESP 32 hall sensor example: https://gist.github.com/xxlukas42/7e7e18604f61529b8398f7fcc5785251

## Common stage: create an application in TTN console
![application creation](/images/appcreation.png)

## First test: ABP enrolment mode

In ABP mode, the AppSKey (the key for payload encryption) and the NwkSKey (the key for message integrity check) are statically generated and included in the device's code. 

**This is considered insecure, but it is handfull for tests**

### Step 1: Device registration
Device must be registered though TTN portal. Device is attached to th application that has been previously created.

![alt](/images/devicereg.png)

By default, the Activation Method is set to OTAA. For the test, it must be changed to ABP in the dvice's settings.

![alt](/images/changeABP.png)

Once validated, NwSKey and AppSKey are generated by the portal:

![alt](/images/ABPKeys.png)

### Step 2: start to code!
First thing to do is to import all the necessary headers:

    #include <U8x8lib.h>    // For Heltec Lora32 oled display
    #include <stdlib.h>
    #include <Arduino.h>
    #include "secrets.h"    // For Application and Network keys
    #include <lmic.h>       // For LMIC lib
    #include <hal/hal.h>
    #include <SPI.h>        // Required by U8x8lib

Then it is necessary to tell the LMIC library the secrets that will be used to authenticate the board (NwkSkey) and to encrypt data (AppSkey):

    // LoRaWAN NwkSKey, network session key
    static const PROGMEM u1_t NWKSKEY[16] = _NWKSKEY;       // secrets.h
    // LoRaWAN AppSKey, application session key
    static const u1_t PROGMEM APPSKEY[16] = _APPSKEY;       // secrets.h
    // LoRaWAN end-device address (DevAddr)
    static const u4_t DEVADDR = _DEVADDR;                   // secrets.h

For security reasons I decided to put these data in a separate header file (*secrets.h*) wich is not tracked by git. Basic precaution :). Device address is a 32 bits constant, whereas NwkSkey and AppSkey are 16 bytes arrays:

    #define _APPSKEY {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
    #define _NWKSKEY {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
    #define _DEVADDR 0x00000000D

The LMIC library also needs to know on which pin the Semtech sx1297 chip is connected. This information is passed thought a *lmic_pinmap* structure:

    // Setup the pins to be used to communicate with Semtech lx1297 chip (specific to Heltec Lora32 v2)
    const lmic_pinmap lmic_pins = {
        .nss = 18,
        .rxtx = LMIC_UNUSED_PIN,
        .rst = 14,                       // reset pin
        .dio = {26, 33, 32}, 
    };


